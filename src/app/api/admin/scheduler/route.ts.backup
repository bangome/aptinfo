import { NextRequest, NextResponse } from 'next/server';
import { getCronScheduler } from '@/services/cronScheduler';
import { normalizeError, logError } from '@/lib/error-handling';

export async function GET(request: NextRequest) {
  try {
    console.log('ğŸ“Š ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ ì¡°íšŒ ìš”ì²­');
    
    const scheduler = getCronScheduler();
    const statusReport = scheduler.getStatusReport();
    
    console.log(`âœ… ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ ì¡°íšŒ ì™„ë£Œ: ${statusReport.totalJobs}ê°œ ì‘ì—… ì¤‘ ${statusReport.runningJobs}ê°œ ì‹¤í–‰ ì¤‘`);
    
    return NextResponse.json({
      success: true,
      data: statusReport,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    const errorDetails = normalizeError(error);
    logError(errorDetails, { context: 'scheduler-status-api' });
    
    console.error('âŒ ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:', error);
    
    return NextResponse.json({
      success: false,
      error: errorDetails.userMessage,
      details: errorDetails.technicalMessage
    }, { status: 500 });
  }
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { action, jobId } = body;

    if (!action) {
      return NextResponse.json({
        success: false,
        error: 'action íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.',
        validActions: ['start', 'stop', 'restart', 'run']
      }, { status: 400 });
    }

    console.log(`ğŸ¯ ìŠ¤ì¼€ì¤„ëŸ¬ ì œì–´ ìš”ì²­: ${action}${jobId ? ` (ì‘ì—…: ${jobId})` : ''}`);
    
    const scheduler = getCronScheduler();
    let result;

    switch (action) {
      case 'start':
        scheduler.startAllJobs();
        result = { message: 'ëª¨ë“  ìŠ¤ì¼€ì¤„ ì‘ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.' };
        break;

      case 'stop':
        scheduler.stopAllJobs();
        result = { message: 'ëª¨ë“  ìŠ¤ì¼€ì¤„ ì‘ì—…ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.' };
        break;

      case 'restart':
        scheduler.stopAllJobs();
        // ì ì‹œ ëŒ€ê¸° í›„ ì¬ì‹œì‘
        await new Promise(resolve => setTimeout(resolve, 1000));
        scheduler.startAllJobs();
        result = { message: 'ëª¨ë“  ìŠ¤ì¼€ì¤„ ì‘ì—…ì´ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.' };
        break;

      case 'run':
        if (!jobId) {
          return NextResponse.json({
            success: false,
            error: 'run ì•¡ì…˜ì„ ìœ„í•´ì„œëŠ” jobId íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
          }, { status: 400 });
        }

        // ì‘ì—… ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        const job = scheduler.getJob(jobId);
        if (!job) {
          return NextResponse.json({
            success: false,
            error: `ì‘ì—… '${jobId}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
            availableJobs: scheduler.getJobs().map(j => ({ id: j.id, name: j.name }))
          }, { status: 400 });
        }

        // ì‘ì—… ìˆ˜ë™ ì‹¤í–‰
        await scheduler.runJobNow(jobId);
        result = { 
          message: `ì‘ì—… '${job.name}'ì´ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.`,
          jobId,
          jobName: job.name
        };
        break;

      default:
        return NextResponse.json({
          success: false,
          error: `ì•Œ ìˆ˜ ì—†ëŠ” ì•¡ì…˜: ${action}`,
          validActions: ['start', 'stop', 'restart', 'run']
        }, { status: 400 });
    }

    console.log(`âœ… ìŠ¤ì¼€ì¤„ëŸ¬ ì œì–´ ì™„ë£Œ: ${action}`);
    
    return NextResponse.json({
      success: true,
      action,
      jobId: jobId || null,
      data: result,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    const errorDetails = normalizeError(error);
    logError(errorDetails, { context: 'scheduler-control-api' });
    
    console.error('âŒ ìŠ¤ì¼€ì¤„ëŸ¬ ì œì–´ ì‹¤íŒ¨:', error);
    
    return NextResponse.json({
      success: false,
      error: errorDetails.userMessage,
      details: errorDetails.technicalMessage
    }, { status: 500 });
  }
}
